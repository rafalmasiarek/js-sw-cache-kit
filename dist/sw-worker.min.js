(()=>{const y="v3.0.0";let S="seed-0001",_=[],A=!1,T=null,$=!1,m="sw-img-cache",g="sw-fonts-cache",w=3e3,b=null,k=[],I=[],L=[];const d="/__sw-api/",v=null,ne=!1,H=/(\.(png|jpe?g|webp|avif|gif|svg|ico|woff2?|ttf|otf|eot)(\?.*)?)$/i;const re=/(\.(woff2?|ttf|otf|eot)(\?.*)?)$/i,J=(...e)=>ne&&console.log("[SW]",...e),h={hit:0,miss:0,revalidate_ok:0,revalidate_fail:0,seed_ok:0,seed_fail:0,purge_ok:0,purge_fail:0},E=[],se=200;function R(e){E.push(`[${new Date().toISOString()}] ${e}`),E.length>se&&E.shift()}const ae="sw-cache-events";function W(e,t){try{const n=new BroadcastChannel(ae);n.postMessage({type:e,payload:t}),n.close()}catch{}}function P(e){return e==="1"||e==="true"||e==="yes"}function j(e){return e.split(",").map(t=>t.trim()).filter(Boolean)}function oe(e,t=";"){return e.split(t).map(n=>n.trim()).filter(Boolean)}async function ie(){try{const e=new URL(self.location.href).searchParams,t=e.get("seed"),n=e.get("allow"),r=e.get("apply"),s=e.get("fallback"),a=e.get("acceptKey"),i=e.get("imgCache"),o=e.get("fontCache"),c=e.get("lruMax"),l=e.get("manifest"),f=e.get("preload"),p=e.get("preconnect"),u=e.get("blacklist");t&&(S=t),n&&(_=j(n)),r!==null&&(A=P(r)),s&&(T=decodeURIComponent(s)),a!==null&&($=P(a)),i&&(m=i),o&&(g=o),c&&(w=Math.max(100,parseInt(c,10)||w)),l&&(b=l),f&&(k=j(f)),p&&(I=j(p)),u&&(L=oe(u))}catch(e){J("url params parse err",e)}}async function ce(){try{const e=await fetch("/_sw-config.json?ts="+Date.now(),{cache:"no-store"});if(!e.ok)return;const t=await e.json();t.cacheSeed&&(S=t.cacheSeed),Array.isArray(t.domainWhitelist)&&(_=t.domainWhitelist),"applySeedToNetwork"in t&&(A=!!t.applySeedToNetwork),t.fallback&&(T=t.fallback),"acceptKey"in t&&($=!!t.acceptKey),t.imgCacheName&&(m=t.imgCacheName),t.fontCacheName&&(g=t.fontCacheName),t.lruMax&&(w=Math.max(100,parseInt(t.lruMax,10)||w)),t.manifest&&(b=t.manifest),Array.isArray(t.preload)&&(k=t.preload),Array.isArray(t.preconnect)&&(I=t.preconnect),Array.isArray(t.blacklist)&&(L=t.blacklist)}catch(e){J("ext cfg err",e)}}function le(e){return(e.headers.get("Accept")||"").includes("text/html")}function V(e){if(!_.length)return!0;const t=e.host.toLowerCase();return _.some(n=>n.toLowerCase()===t)}function Y(e){try{const t=e.pathname;return L.some(n=>new RegExp(n).test(t))}catch{return!1}}function pe(e){const t=new URL(e.url);return H.test(t.pathname)}function fe(e){return re.test(e.pathname)}function ue(e){if(!$)return"";const t=e.headers.get("Accept")||"";let n=0;for(let r=0;r<t.length;r++)n=n*31+t.charCodeAt(r)|0;return String(n>>>0)}function O(e){const t=new URL(typeof e=="string"?e:e.url);t.searchParams.set("__sw_seed",S);const n=ue(typeof e=="string"?new Request(e):e);return n&&t.searchParams.set("__sw_accept",n),new Request(t.toString(),{method:"GET"})}const z=e=>fe(e)?`${g}-${y}`:`${m}-${y}`,K=e=>A?O(e):e;async function N(e,t,n){if(n&&(n.ok||n.type==="opaque"))try{await e.put(t,n)}catch{}}async function U(e,t){try{const n=await caches.open(e),r=await n.keys();if(r.length<=t)return;const s=r.length-t;for(let a=0;a<s;a++)await n.delete(r[a]);R(`trim ${e} -${s}`)}catch{}}function X(e,t={}){try{if(!e||e.type==="opaque")return e;const n=new Headers(e.headers||void 0);for(const[r,s]of Object.entries(t))n.set(r,String(s));return new Response(e.body,{status:e.status,statusText:e.statusText,headers:n})}catch{return e}}async function B(e,t,n){return fetch(e,n?{mode:"no-cors"}:void 0)}self.addEventListener("install",e=>{e.waitUntil((async()=>{if(await ie(),await ce(),Array.isArray(k)&&k.length)try{const t=k.map(n=>{try{return new URL(n,self.location).toString()}catch{return null}}).filter(Boolean);await Promise.allSettled(t.map(n=>fetch(n,{mode:"no-cors"})))}catch{}})()),self.skipWaiting()});self.addEventListener("activate",e=>{e.waitUntil((async()=>{const t=new Set([`${m}-${y}`,`${g}-${y}`]),n=await caches.keys();await Promise.all(n.filter(r=>!t.has(r)).map(r=>caches.delete(r))),await self.clients.claim()})())});self.addEventListener("fetch",e=>{const t=e.request;if(t.method!=="GET")return;const n=new URL(t.url);if(n.origin===self.location.origin&&n.pathname.startsWith(d)){e.respondWith(he(e));return}if(le(t)||!pe(t)||!V(n)||Y(n))return;const r=z(n),s=O(t);e.respondWith((async()=>{const a=await caches.open(r),i=await a.match(s,{ignoreVary:!0});if(i)return h.hit++,R(`HIT ${n.pathname}`),e.waitUntil((async()=>{try{const o=n.origin!==self.location.origin,c=K(t),l=await B(c,t,o);await N(a,s,l&&l.clone()),h.revalidate_ok++,W("revalidated",{key:s.url}),await U(r,w)}catch(o){h.revalidate_fail++,R(`revalidate fail: ${o}`)}})()),X(i,{"X-SW-Cache":"HIT","X-SW-Source":"cache","X-SW-Seed":S,"X-SW-Version":y});try{const o=n.origin!==self.location.origin,c=K(t),l=await B(c,t,o);return await N(a,s,l.clone()),h.miss++,R(`MISS ${n.pathname}`),await U(r,w),X(l,{"X-SW-Cache":"MISS","X-SW-Source":"network","X-SW-Seed":S,"X-SW-Version":y})}catch{if(T)try{return await fetch(T)}catch{return Response.error()}return Response.error()}})())});function G(e){return v?e.headers.get("x-sw-secret")===v:!0}async function he(e){const t=e.request,n=new URL(t.url),r=(n.searchParams.get("dry")||"")==="1";if(n.pathname===`${d}openapi.json`)return new Response(JSON.stringify(me()),{headers:{"Content-Type":"application/json"}});if(n.pathname===`${d}metrics`&&t.method==="GET"){const s=(n.searchParams.get("format")||"prom").toLowerCase();if(s==="json")return new Response(JSON.stringify(h),{headers:{"Content-Type":"application/json"}});if(s==="pretty"){const o=`<!doctype html><meta charset="utf-8"><title>SW Metrics</title>
      <table border="1" cellpadding="6">${Object.entries(h).map(([c,l])=>`<tr><td>${c}</td><td>${l}</td></tr>`).join("")}</table>`;return new Response(o,{headers:{"Content-Type":"text/html; charset=utf-8"}})}const a=Object.entries(h).map(([i,o])=>`sw_${i} ${o}`).join(`
`)+`
`;return new Response(a,{headers:{"Content-Type":"text/plain; version=0.0.4"}})}if(n.pathname===`${d}status`&&t.method==="GET")return C({ok:!0,version:y,seed:S,allowlist:_,applySeedToNetwork:A,fallback:T,acceptKey:$,imgCacheName:m,fontCacheName:g,lruMax:w,manifest:b,preload:k,preconnect:I,blacklist:L});if(n.pathname===`${d}list`&&t.method==="GET"){const s=[`${m}-${y}`,`${g}-${y}`],a=[];for(const i of s){const c=await(await caches.open(i)).keys();a.push({cache:i,count:c.length,keys:c.map(l=>l.url)})}return C({ok:!0,caches:a})}if(n.pathname===`${d}seed`&&t.method==="POST"){if(!G(t))return new Response("forbidden",{status:403});const s=await D(t),a=await ye(s,r);return C(a)}if(n.pathname===`${d}purge`&&t.method==="POST"){if(!G(t))return new Response("forbidden",{status:403});const s=await D(t),a=await de(s,r);return C(a)}if(n.pathname==="/_sw/debug"){const s=`<!doctype html><meta charset="utf-8"><title>Service Worker Debug</title>
      <style>body{font-family:system-ui,Arial,sans-serif;padding:20px}pre{white-space:pre-wrap}</style>
      <h1>Service Worker Debug</h1>
      <h2>Metrics</h2><pre>${JSON.stringify(h,null,2)}</pre>
      <h2>Recent log</h2><pre>${E.map(a=>a).join(`
`)}</pre>`;return new Response(s,{headers:{"Content-Type":"text/html; charset=utf-8"}})}return new Response("not found",{status:404})}function C(e,t=200){return new Response(JSON.stringify(e),{status:t,headers:{"Content-Type":"application/json"}})}async function D(e){try{return await e.json()}catch{return{}}}async function F(e,t,n,r=1/0){try{const s=await fetch(e,{cache:"no-store"});if(!s.ok)return[];const a=await s.json();let i=Array.isArray(a)?a.map(o=>typeof o=="string"?o:o.path||"").filter(Boolean):[];if(t&&(i=i.filter(o=>o.startsWith(t))),n){const o=Q(n);i=i.filter(c=>o.test(c))}return Number.isFinite(r)&&(i=i.slice(0,r)),i}catch{return[]}}function Q(e){let t=String(e).replace(/[.+^${}()|[\]\\]/g,n=>"\\"+n);return t=t.replace(/\*\*/g,".*").replace(/\*/g,"[^/]*"),new RegExp("^"+t+"$")}async function ye(e,t){const n=Array.isArray(e.keys)?e.keys:null,r=e.prefix||null,s=e.glob||null,a=e.manifest||b||null,i=e.max||null;let o=[];n&&n.length?o=n:r||s?o=a?await F(a,r,s,i||1/0):[]:a&&(o=await F(a,null,null,i||1/0));const c=[];let l=0;for(const f of o)try{const p=new URL(f,self.location).toString(),u=new URL(p);if(!H.test(u.pathname)||Y(u)||!V(u)){c.push({key:p,ok:!1,reason:"not-static-or-not-allowed"});continue}if(t){c.push({key:p,ok:!0,dry:!0}),l++;continue}const x=z(u),Z=await caches.open(x),q=O(p),ee=u.origin!==self.location.origin,te=A?q:new Request(p,{method:"GET"}),M=await fetch(te,ee?{mode:"no-cors"}:void 0);await N(Z,q,M&&M.clone()),c.push({key:p,ok:!0}),l++,h.seed_ok++}catch(p){c.push({key:String(f),ok:!1,error:String(p)}),h.seed_fail++}return W("seeded",{count:l}),{ok:!0,seeded:c,count:l,dry:!!t}}async function de(e,t){const n=Array.isArray(e.keys)?e.keys:null,r=e.prefix||null,s=e.glob||null,a=[`${m}-${y}`,`${g}-${y}`],i=[];for(const f of a){const u=await(await caches.open(f)).keys();i.push(...u.map(x=>({cache:f,req:x})))}let o=[];if(n&&n.length){const f=new Set(n.map(p=>new URL(p,self.location).toString()));o=i.filter(p=>f.has(new URL(p.req.url).toString().replace(/&__sw_accept=\d+/,"")))}else if(r||s){const f=s?Q(s):null;o=i.filter(p=>{const u=new URL(p.req.url).pathname;return r?u.startsWith(r):f.test(u)})}let c=0;const l=[];for(const f of o)try{if(t){l.push({key:f.req.url,removed:0,dry:!0});continue}const u=await(await caches.open(f.cache)).delete(f.req);u&&c++,l.push({key:f.req.url,removed:u?1:0}),h.purge_ok+=u?1:0}catch(p){l.push({key:f.req.url,error:String(p)}),h.purge_fail++}return W("purged",{removed:c}),{ok:!0,purged:l,count:c,dry:!!t}}function me(){return{openapi:"3.0.3",info:{title:"SW Cache API",version:"3.0.0"},paths:{"/__sw-api/status":{get:{summary:"Status",responses:{200:{description:"OK"}}}},"/__sw-api/list":{get:{summary:"List cache keys",responses:{200:{description:"OK"}}}},"/__sw-api/seed":{post:{summary:"Seed cache",requestBody:{content:{"application/json":{schema:{oneOf:[{type:"object",properties:{keys:{type:"array",items:{type:"string"}},dry:{type:"boolean"}},required:["keys"]},{type:"object",properties:{prefix:{type:"string"},max:{type:"integer"},dry:{type:"boolean"}},required:["prefix"]},{type:"object",properties:{glob:{type:"string"},max:{type:"integer"},dry:{type:"boolean"}},required:["glob"]},{type:"object",properties:{manifest:{type:"string"},max:{type:"integer"},dry:{type:"boolean"}},required:["manifest"]}]}}}},responses:{200:{description:"OK"}}}},"/__sw-api/purge":{post:{summary:"Purge cache",requestBody:{content:{"application/json":{schema:{oneOf:[{type:"object",properties:{keys:{type:"array",items:{type:"string"}},dry:{type:"boolean"}},required:["keys"]},{type:"object",properties:{prefix:{type:"string"},dry:{type:"boolean"}},required:["prefix"]},{type:"object",properties:{glob:{type:"string"},dry:{type:"boolean"}},required:["glob"]}]}}}},responses:{200:{description:"OK"}}}},"/__sw-api/metrics":{get:{summary:"Metrics",parameters:[{name:"format",in:"query",schema:{type:"string",enum:["prom","json","pretty"]}}],responses:{200:{description:"OK"}}}},"/__sw-api/openapi.json":{get:{summary:"OpenAPI document",responses:{200:{description:"OK"}}}}}}}self.addEventListener("message",()=>{});})();
